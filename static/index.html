<!DOCTYPE html>
<html>
<head>
	<title>Driver HUD</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="gauge.min.js"></script>
	{# <script type="text/javascript">
		const MAX_SPEED = 60;
		let speedometer;
		let errors = [];

		window.onload = () => {
			initSpeedometer();
			clockTick();
			updateData();

			setInterval(clockTick, 1000);
			setInterval(updateData, 100);
		}

		function initSpeedometer() {
			var ticks = [];
			for (var i = 0; i <= MAX_SPEED/10; i++) ticks.push(i*10);
			speedometer = new Donut(document.getElementById("speedometer")).setOptions({
				angle: 0.25, // The span of the gauge arc
				lineWidth: 0.1, // The line thickness
				radiusScale: 1, // Relative radius, change this if clipping off canvas
				/*
				pointer: {
					length: 0.6, // // Relative to gauge radius
					strokeWidth: 0.035, // The thickness
					color: '#EB0909' // Fill color
				},
				*/
				limitMax: true,     // If false, max value increases automatically if value > maxValue
				limitMin: true,     // If true, the min value of the gauge will be fixed
				colorStart: '#6f6fa0',
				colorStop: '#c0c0db',
				strokeColor: '#eee',
				generateGradient: true,
				highDpiSupport: true,     // High resolution support
				/*
				staticLabels: {
					font: "3vw sans-serif",  // Specifies font
					labels: ticks,  // Print labels at these values
					color: "#000000",  // Optional: Label text color
					fractionDigits: 0  // Optional: Numerical precision. 0=round off.
				},
				*/
			});
			speedometer.maxValue = MAX_SPEED;
			speedometer.setMinValue(0);
			speedometer.animationSpeed = 16;
			speedometer.setTextField(document.getElementById("motor-speed"));
			speedometer.set(0);
		}

		function clockTick() {
			let d = new Date();
			let hour = ((d.getHours() % 12) || 12);
			//hour = (hour < 10 ? "&nbsp;" : "") + hour; // Pad hour
			let colon = d.getSeconds() % 2 ? ":" : " ";
			let min = (d.getMinutes() < 10 ? "0" : "") + d.getMinutes()
			let amOrPm = d.getHours() >= 12 ? "pm" : "am";
			document.getElementById("clock").innerHTML = hour + colon + min + amOrPm;
		}

		function readSensor(endpoint, callback) {
			let xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					callback(this.response);
				} else {
					// Display error to driver?
				}
			};
			xhttp.open("GET", endpoint + "?" + Date.now(), true); // Date.now() prevents caching
			xhttp.send();
		}

		function populateData(data) {
			document.getElementById("battery-percent").innerHTML = data["soc"];
			document.getElementById("pack-voltage").innerHTML = data["pvolt"];
			document.getElementById("solar-voltage").innerHTML = data["svolt"];
			document.getElementById("pack-temp").innerHTML = data["temp"];
			//document.getElementById("motor-speed").innerHTML = data["speed"];
			speedometer.set(parseInt(data["speed"]));

			let errorRegion = document.getElementById("error-region");
			if (data["error"].length == 0) {
				if (!errorRegion.classList.contains("no-error")) {
					errorRegion.classList.add("no-error");
				}
				if (errorRegion.classList.contains("error")) {
					errorRegion.classList.remove("error");
				}
			} else {
				if (errorRegion.classList.contains("no-error")) {
					errorRegion.classList.remove("no-error");
				}
				if (!errorRegion.classList.contains("error")) {
					errorRegion.classList.add("error");
				}
			}

			let errorList = document.getElementById("error-list");
			while(errorList.firstChild) {
				errorList.removeChild(errorList.firstChild);
			}
			if (data["error"].length > 0) {
				data["error"].map((err) => {
					let errNode = document.createElement("span");
					errNode.innerText = err;
					errorList.appendChild(errNode);
				});
			} else {
					let errNode = document.createElement("span");
					errNode.innerText = "No Errors";
					errorList.appendChild(errNode);
			}
		}

		function updateData() {
			readSensor("/get-data", data => populateData(JSON.parse(data)));
		}
	</script> #}
</head>
<body onclick="location.reload()"> <!-- Tap anywhere to reload in case something breaks -->
	<div id="gauge">
        <canvas id="canvasId" width="800px" height="480px"></canvas>
    </div>
	<script src="config.js"></script>
    <script src="gauge.js"></script>
    <script>
        let batteryCurrent = new Gauge(config.batteryCurrent);
        let motorCurrent = new Gauge(config.motorCurrent);
        let solarCurrent = new Gauge(config.solarCurrent);
        let minCellVolt = new Gauge(config.minCellVolt);
        let soc = new Gauge(config.soc);
        let speed = new Gauge(config.speed);
        let time = new Gauge(config.time);
        let packVolt = new Gauge(config.packVolt);
        let minPackTemp = new Gauge(config.minPackTemp);
        let maxPackTemp = new Gauge(config.maxPackTemp);
        let motorTemp = new Gauge(config.motorTemp);
        let maxCellVolt = new Gauge(config.maxCellVolt);

        batteryCurrent.setValue(2.4);
        motorCurrent.setValue(2.4);
        solarCurrent.setValue(2.4);
        minCellVolt.setValue(3.6);
        soc.setValue(55);
        speed.setValue(30);
        time.setValue(720);
        packVolt.setValue(90);
        minPackTemp.setValue(22);
        maxPackTemp.setValue(26);
        motorTemp.setValue(45);
        maxCellVolt.setValue(5);
    </script>
</body>
</html>
