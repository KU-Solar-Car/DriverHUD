<!DOCTYPE html>
<html>
<head>
	<title>Driver HUD</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body onclick="location.reload()"> <!-- Tap anywhere to reload in case something breaks -->
    <svg width="800px" height="480px" id="svgId">
        <style>
            .valueText {
                font-family: Helvetica;
                text-anchor: middle;
                font-size: 24px;
            }
            .valueSpan {
                font-family: Helvetica;
                text-anchor: middle;
                font-size: 24px;
            }
            .labelSpan {
                font-family: Helvetica;
                text-anchor: middle;
                font-size: 16px;
            }
            .minText {
                font-family: Helvetica;
                text-anchor: end;
                font-size: 16px;
            }
            .maxText {
                font-family: Helvetica;
                text-anchor: start;
                font-size: 16px;
            }
            .gaugePath {
                stroke-linecap: butt;
                transform: rotate(135deg);
                transition: stroke-dashoffset 100ms ease-in-out;
            }
			.faultBox {
				fill: rgba(255, 0, 0, 0.4);
			}
        </style>
    </svg>
	<script src="config.js"></script>
    <script src="gauge.js"></script>
    <script src="faults.js"></script>
    <script>
		let requestData = (endpoint, callback) => {
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					callback(JSON.parse(this.responseText));
				} else {
					// Display error to driver?
				}
			};
			xhttp.open("GET", endpoint + "?" + Date.now(), true); // Date.now() prevents caching
			xhttp.send();
		};

        let batteryCurrent = new Gauge(config.batteryCurrent);
        let motorCurrent = new Gauge(config.motorCurrent);
        let solarCurrent = new Gauge(config.solarCurrent);
        let minCellVolt = new Gauge(config.minCellVolt);
        let soc = new Gauge(config.soc);
        let speed = new Gauge(config.speed);
        let time = new Gauge(config.time);
        let packVolt = new Gauge(config.packVolt);
        let minPackTemp = new Gauge(config.minPackTemp);
        let maxPackTemp = new Gauge(config.maxPackTemp);
        let motorTemp = new Gauge(config.motorTemp);
        let maxCellVolt = new Gauge(config.maxCellVolt);

		let faults = new FaultBox({
			"svgId": "svgId"
		});
		faults.draw();

		let updateGauges = (data) => {
			batteryCurrent.setValue(data["batteryCurrent"]);
			motorCurrent.setValue(data["motorCurrent"]);
			solarCurrent.setValue(data["solarCurrent"]);
			minCellVolt.setValue(data["minCellVolt"]);
			soc.setValue(data["soc"]);
			speed.setValue(data["speed"]);
			packVolt.setValue(data["packVolt"]);
			minPackTemp.setValue(data["minPackTemp"]);
			maxPackTemp.setValue(data["maxPackTemp"]);
			motorTemp.setValue(data["motorTemp"]);
			maxCellVolt.setValue(data["maxCellVolt"]);

			let d = new Date();
			let hour = d.getHours().toString().padStart(2, '0');
			let minute = d.getMinutes().toString().padStart(2, '0');
			timeString = `${hour}:${minute}`;
			time.setValue(timeString);
		}

/*
		setTimeout(() => {
		faults.setErrorMessages([
			"Discharge Limit",
			"Charger Relay",
			"Int Hardware",
			"Int HS Therm",
			"Int Software",
			"Max Cell V High",
			"Min Cell V Low",
			"Pack Too Hot",
			"Int Comm",
			"Cell Balancing",
			"Weak Cell",
			"Low Cell Voltage",
			"Open Wiring",
			"Current Sensor",
			"Max Cell > 5V",
			"Cell ASIC",
			"Weak Pack",
			"Fan Monitor",
			"Thermistor",
			"Ext Comm",
			"Redundant PS",
			"High Volt Iso",
			"Input PS",
			"Charge Limit"
		]);
		}, 10000);

		setTimeout(() => {
			faults.setErrorMessages([]);
		}, 5000);
*/

		/*
		let i = 0;
		setInterval(() => {
			let rand = i; //Math.floor(Math.random() * 60);
			i++;
			speed.setValue(rand);
		}, 1000);
		*/

		setInterval(() => {requestData('/get-data', updateGauges)}, 100);
    </script>
</body>
</html>
