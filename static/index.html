<!DOCTYPE html>
<html>
<head>
	<title>Driver HUD</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="style.css">
	<script type="text/javascript">
		window.onload = () => {
			clockTick();
			updateData();
			
			setInterval(clockTick, 1000);
			setInterval(updateData, 100);
		}
		
		function clockTick() {
			let d = new Date();
			let hour = ((d.getHours() % 12) || 12);
			//hour = (hour < 10 ? "&nbsp;" : "") + hour; // Pad hour
			let colon = d.getSeconds() % 2 ? ":" : " ";
			let min = (d.getMinutes() < 10 ? "0" : "") + d.getMinutes()
			let amOrPm = d.getHours() >= 12 ? "pm" : "am";
			document.getElementById("clock").innerHTML = hour + colon + min + amOrPm;
		}
		
		function readSensor(endpoint, callback) {
			let xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					callback(this.response);
				} else {
					// Display error to driver?
				}
			};
			xhttp.open("GET", endpoint + "?" + Date.now(), true); // Date.now() prevents caching
			xhttp.send();
		}

		function populateData(data) {
			document.getElementById("battery-percent").innerText = data["soc"];
			document.getElementById("pack-voltage").innerHTML = data["pvolt"];
			document.getElementById("solar-voltage").innerHTML = data["svolt"];
			document.getElementById("pack-temp").innerHTML = data["temp"];
			document.getElementById("motor-speed").innerHTML = data["speed"];
			document.getElementById("error-msg").innerHTML = data["error"];

			let error_elem = document.getElementById("error-region");
			if (data["error"].length === 0) {
				if (!error_elem.classList.contains("no-error")) {
					error_elem.classList.add("no-error");
				}
				if (error_elem.classList.contains("error")) {
					error_elem.classList.remove("error");
				}
			} else {
				if (error_elem.classList.contains("no-error")) {
					error_elem.classList.remove("no-error");
				}
				if (!error_elem.classList.contains("error")) {
					error_elem.classList.add("error");
				}
			}
		} 

		function updateData() {
			readSensor("/get-data", data => populateData(JSON.parse(data)));
		}

		// Not yet implemented in Flask
		/*function updateError() {
			readSensor("/get-bps-error", error => document.getElementById("error").style.display = error ? "block" : "none");
		}*/
	</script>
</head>
<body onclick="location.reload()"> <!-- Tap anywhere to reload in case something breaks -->
	<div class="grid">
		<div id="error-region" class="no-error">
			<span id="error-msg">NO ERRORS!</span>
		</div>
		<div class="dataViewer time" id="time">
			<span id="clock">00:00</span>
		</div>
		<div class="dataViewer soc" id="soc">
			<span id="battery-percent">0</span>%
		</div>
		<div class="dataViewer pvolt" id="pvolt">
			<span id="pack-voltage">0</span>V
		</div>
		<div class="dataViewer svolt" id="svolt">
			<span id="solar-voltage">0</span>V
		</div>
		<div class="dataViewer ptemp" id="ptemp">
			<span id="pack-temp">0</span>&deg;C
		</div>
		<div class="dataViewer speed" id="speed">
			<span id="motor-speed">0</span>mph
		</div>
	</div>
</body>
</html>
